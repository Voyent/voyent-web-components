<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../bridgeit-io-import/bridgeit-io-import.html">
<link rel="import" href="../../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../paper-item/paper-item.html">
<link rel="import" href="../../paper-item/paper-item-body.html">
<link rel="import" href="../../paper-tabs/paper-tabs.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../../paper-input/paper-input.html">
<link rel="import" href="../../paper-item/paper-item.html">
<link rel="import" href="../../paper-item/paper-item-body.html">
<link rel="import" href="../../paper-listbox/paper-listbox.html">
<link rel="import" href="../../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../iron-icons/iron-icons.html">
<link rel="import" href="../../iron-icon/iron-icon.html">
<link rel="import" href="../../iron-label/iron-label.html">
<link rel="import" href="../../iron-pages/iron-pages.html">
<link rel="import" href="../../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bridgeit-query-editor/bridgeit-query-editor.html">
<link rel="import" href="../bridgeit-code-editor/bridgeit-code-editor.html">

<!--
Displays an editor that can be used for building cross collection query chains for data stored by the BridgeIt Services.

Example:

		<bridgeit-query-chain-editor realm="myRealm"
                                 account="myAccount">
		</bridgeit-query-chain-editor>

@demo demo.html
-->
<dom-module id="bridgeit-query-chain-editor">
    <template>
        <style is="custom-style" type="text/css">
            /* Customizable Styles */
            .section {
                @apply(--query-chain-editor-section);
            }
            .palette {
                @apply(--query-chain-editor-palette);
            }
            .palette-item {
                cursor:move;
                @apply(--query-chain-editor-palette-item);
            }
            .workflow {
                border: 1px dotted transparent;
                background-color: transparent;
                @apply(--query-chain-editor-workflow);
            }
            @-webkit-keyframes yellow-fade {   
                0% {background: #ffff79;}
            }
            @keyframes yellow-fade {
                0% {background: #ffff79;}
            }
            .dropzone {
                border: 1px dotted black;
                -webkit-animation: yellow-fade 1500ms ease-in 1;
                animation: yellow-fade 1500ms ease-in 1;
            }
            .workflow-drop-area {
                padding-bottom:100px;
                @apply(--query-chain-editor-workflow-drop-area);
            }
            .execute {
                text-align:center;
                @apply(--query-chain-editor-execute);
            }
            .execute-item {
                height:300px;
                @apply(--query-chain-editor-execute);
            }
            .results {
                @apply(--query-chain-editor-results);
            }
            .header-panel {
                height:300px;
                border: 1px solid #777;
                @apply(--query-chain-editor-header-panel);
            }
            .tab-content {
                height:260px;
                border: 1px solid #777;
                overflow-y:scroll;
                @apply(--query-chain-editor-tab-content);
            }
            .collapsed {
                width: 50px;
                max-width: 80px;
            }
            .collapsed .flex {
                visibility: hidden;
            }
            .collapsed h2 {
                font-size: small;
            }
            /* Preset Styles */
            .palette, .workflow, .execute {
                padding: 0 10px 0 10px;
            }
            .container {
                max-width:none;
            }
            .execute-item paper-button {
                position: relative;
                top: 50%;
                transform: translateY(-50%);
                -webkit-transform: translateY(-50%);
                -ms-transform: translateY(-50%);
            }
            iron-label {
                font-family: 'Roboto', 'Noto', sans-serif;
                -webkit-font-smoothing: antialiased;
                font-size: 16px;
                font-weight: 400;
            }
            .empty-span {
                height:300px;
                display:block;
            }
            .no-padding {
                padding:0;
            }
            .right {
                text-align: right;
            }
            .hidden-header {
                color:transparent;
            }
            /* Custom Styles */
            paper-toolbar {
                --paper-toolbar-height: 40px;
                --paper-toolbar: {
                    background: rgba(2, 114, 68, 0.8);
                    color: #ffffff;
                }
            }
            paper-tabs {
                --paper-tabs: {
                    height:40px;
                };
            }
            paper-tab {
                --paper-tab: {
                    background: rgba(2, 114, 68, 0.8);
                    color: #ffffff;
                    height:40px;
                };
            }
            paper-dropdown-menu {
                --paper-dropdown-menu: {
                    width:100%;
                };
            }
            bridgeit-code-editor {
                --code-editor: {
                    height:260px;
                };
            }
        </style>
        <div class="container flex layout horizontal">
            <div class="flex">
                <h3>Current Workflow</h3>
                
                <div class="flex layout vertical">
                    <paper-input label="Query Chain ID" value="{{_workflow._id}}" required="true" minlength="1" maxlength="50"></paper-input>
                    <paper-input label="Query Chain Title" value="{{_workflow.properties.title}}" required="true" minlength="3" maxlength="25"></paper-input>
                    <div class="flex layout horizontal">
                        <paper-button raised on-click="executeWorkflow">Execute</paper-button>
                        <paper-button raised on-click="persistWorkflowChain">Save/Update</paper-button>
                        <paper-button raised on-click="resetWorkflow">Reset</paper-button>
                    </div>
                </div>
            </div>
            
            <div class="flex">
                <h3>Request Parameters</h3>
                
                <div class="flex">
                    <paper-tabs selected="{{_workflow.selected}}" no-bar>
                        <paper-tab>Definition</paper-tab>
                        <paper-tab>Test Data</paper-tab>
                    </paper-tabs>
                    
                    <iron-pages selected="{{_workflow.selected}}">
                        <div class="tab-content"> <!-- Definition Page -->
                            <table>
                                <thead>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Default</th>
                                </thead>
                                <template is="dom-repeat" items="{{_workflow.properties.parameters}}" as="param">
                                    <tr>
                                        <td>
                                            <paper-input value="{{param.name}}"></paper-input>
                                        </td>
                                        <td>
                                            <paper-input value="{{param.type}}"></paper-input>
                                        </td>
                                        <td>
                                            <paper-input value="{{param.desc}}"></paper-input>
                                        </td>
                                        <td>
                                            <paper-input value="{{param.default}}"></paper-input>
                                        </td>
                                    </tr>
                                </template>
                                <tr>
                                    <td colspan="4" class="right">
                                        <paper-button on-click="addMainParam">
                                            <iron-icon icon="add-circle" on-click="addMainParam"></iron-icon>
                                        </paper-button>
                                        <paper-button on-click="removeMainParam">
                                            <iron-icon icon="remove-circle" on-click="removeMainParam"></iron-icon>
                                        </paper-button>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="tab-content"> <!-- Test Data Page -->
                            <!-- TODO Prefill this JSON from our request parameter definition JSON created in the other tab -->
                            <bridgeit-code-editor value="{{_workflow.properties.execParams}}"></bridgeit-code-editor>
                        </div>
                    </iron-pages>
                </div>
            </div>
            
            <div class="flex">
                <h3>Saved Workflows</h3>
                
                <div class="flex">
                    <table>
                        <tbody>
                            <template is="dom-repeat" items="[[_savedWorkflows]]" as="savedItem">
                                <tr>
                                    <td>[[savedItem.properties.title]] ([[savedItem._id]])</td>
                                    <td><paper-button raised on-click="loadWorkflow" data-workflow-item$="{{savedItem._id}}">Load</paper-button></td>
                                    <td><paper-button raised on-click="removeWorkflow" data-workflow-item$="{{savedItem._id}}">Delete</paper-button></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <hr/>
        
        <div class="container flex layout horizontal">
            <div id="palette" class="flex-2 section palette">
                <h2>
                    <button on-click="toggleColumn" data-id="palette" data-class="flex-2">&lt;-&gt;</button>
                    Palette
                </h2>
                <div class="container flex layout vertical no-padding">
                    <div class="flex">
                        <div class="header-panel">
                            <paper-header-panel>
                                <paper-toolbar><div>Queries</div></paper-toolbar>
                                
                                <div class="layout horizontal flex">
                                    <paper-dropdown-menu label="Service">
                                        <paper-listbox class="dropdown-content" selected="{{selectedQuery}}">
                                            <template is="dom-repeat" items="[[_queryServices]]" as="qservice">
                                                <paper-item>[[qservice.name]]</paper-item>
                                            </template>
                                        </paper-listbox>
                                    </paper-dropdown-menu>
                                </div>
                                
                                <div class="flex">
                                    <template is="dom-repeat" items="{{_queries}}" as="query">
                                        <paper-item class="palette-item" draggable="true"
                                                    on-dragstart="_startDragQuery" on-dragend="_commonDragEnd">
                                            <paper-item-body>
                                                <div>{{query._id}}</div>
                                            </paper-item-body>
                                            <iron-icon icon="search"></iron-icon>
                                        </paper-item>
                                    </template>
                                </div>
                            </paper-header-panel>
                        </div>
                    </div>
                    <div class="flex">
                        <div class="header-panel">
                            <paper-header-panel>
                                <paper-toolbar><div>Transformers</div></paper-toolbar>
                                
                                <div class="flex">
                                    <template is="dom-repeat" items="{{_transformers}}" as="transformer">
                                        <paper-item class="palette-item" draggable="true"
                                                    on-dragstart="_startDragTransformer" on-dragend="_commonDragEnd">
                                            <paper-item-body>
                                                <div>{{transformer._id}}</div>
                                            </paper-item-body>
                                            <iron-icon icon="compare-arrows"></iron-icon>
                                        </paper-item>
                                    </template>
                                </div>
                            </paper-header-panel>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="workflow" class="flex-3 section workflow">
                <h2>
                    <button on-click="toggleColumn" data-id="workflow" data-class="flex-3">&lt;-&gt;</button>
                    Workflow ([[_arrayLength(_workflow.query.*)]] items)
                </h2>
                <div class="container flex layout vertical no-padding">
                    <div class="flex workflow-drop-area" on-dragover="_dragOverWorkflow" on-drop="_dropInWorkflow">
                        <template is="dom-repeat" items="{{_workflow.query}}" as="workflowItem">
                            <template is="dom-if" if="{{_isQuery(workflowItem.type)}}">
                                <paper-tabs selected="{{workflowItem.selected}}" no-bar>
                                    <paper-tab>Properties</paper-tab>
                                    <paper-tab>Params</paper-tab>
                                    <paper-tab>Query</paper-tab>
                                    <paper-tab>Raw</paper-tab>
                                    <paper-button on-click="removeWorkflowItem" data-workflow-item$="{{workflowItem.id}}">
                                        <iron-icon icon="cancel" on-click="removeWorkflowItem" data-workflow-item$="{{workflowItem.id}}"></iron-icon>
                                    </paper-button>
                                </paper-tabs>

                                <iron-pages selected="{{workflowItem.selected}}">
                                    <div class="tab-content"> <!-- Properties Page -->
                                        <div class="container flex layout vertical">
                                            <div class="flex">
                                                <paper-input label="Query ID:" value="{{workflowItem.item._id}}"></paper-input>
                                            </div>
                                            <div class="flex">
                                                <paper-input label="Service:" value="{{workflowItem.item.properties.service}}"></paper-input>
                                            </div>
                                            <div class="flex">
                                                <paper-input label="Collection:" value="{{workflowItem.item.properties.collection}}"></paper-input>
                                            </div>
                                            <div class="flex">
                                                <iron-label>
                                                    Type:
                                                    <paper-radio-group selected="{{workflowItem.item.properties.type}}">
                                                        <paper-radio-button name="find">Find</paper-radio-button>
                                                        <paper-radio-button name="aggregate">Aggregate</paper-radio-button>
                                                    </paper-radio-group>
                                                </iron-label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-content"> <!-- Params Page -->
                                        <table>
                                            <thead>
                                                <th>Name</th>
                                                <th>Type</th>
                                                <th>Description</th>
                                                <th>Default</th>
                                            </thead>
                                            <template is="dom-repeat" items="{{workflowItem.item.properties.parameters}}" as="param">
                                                <tr>
                                                    <td>
                                                        <paper-input value="{{param.name}}"></paper-input>
                                                    </td>
                                                    <td>
                                                        <paper-input value="{{param.type}}"></paper-input>
                                                    </td>
                                                    <td>
                                                        <paper-input value="{{param.desc}}"></paper-input>
                                                    </td>
                                                    <td>
                                                        <paper-input value="{{param.default}}"></paper-input>
                                                    </td>
                                                </tr>
                                            </template>
                                            <tr>
                                                <td colspan="4" class="right">
                                                    <paper-button on-click="addItemParam" data-workflow-item$="{{workflowItem.id}}">
                                                        <iron-icon icon="add-circle" on-click="addItemParam" data-workflow-item$="{{workflowItem.id}}"></iron-icon>
                                                    </paper-button>
                                                    <paper-button on-click="removeItemParam" data-workflow-item$="{{workflowItem.id}}">
                                                        <iron-icon icon="remove-circle" on-click="removeItemParam" data-workflow-item$="{{workflowItem.id}}"></iron-icon>
                                                    </paper-button>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="tab-content"> <!-- Query Page -->
                                        <template is="dom-if" if="{{_isAggregate(workflowItem.item.properties.type)}}">
                                            <!-- TODO Flesh out the aggregate editor -->
                                            Aggregate Editor
                                        </template>
                                        <template is="dom-if" if="{{_isFind(workflowItem.item.properties.type)}}">
                                            <!-- TODO Properly pre-load query editor with data -->
                                            <bridgeit-query-editor/><!-- account="[[account]]" realm="[[realm]]"
                                                                   service="[[workflowItem.item.properties.service]]"
                                                                   collection="[[workflowItem.item.properties.collection]]"></bridgeit-query-editor>-->
                                        </template>
                                    </div>
                                    <div class="tab-content"> <!-- Raw Page -->
                                        <bridgeit-code-editor value="{{_formatJSON(workflowItem.item.query)}}"></bridgeit-code-editor>
                                    </div>
                                </iron-pages>
                            </template>
                            <template is="dom-if" if="{{_isTransformer(workflowItem.type)}}">
                                <paper-tabs selected="{{workflowItem.selected}}" no-bar>
                                    <paper-tab>Properties</paper-tab>
                                    <template is="dom-if" if="{{_isTransformerMapper(workflowItem.item.properties.type)}}">
                                        <paper-tab>Transformer</paper-tab>
                                        <paper-tab>Raw</paper-tab>
                                    </template>
                                    <template is="dom-if" if="{{!_isTransformerMapper(workflowItem.item.properties.type)}}">
                                        <paper-tab>Transformer Function</paper-tab>
                                    </template>
                                    <paper-button on-click="removeWorkflowItem" data-workflow-item$="{{workflowItem.id}}">
                                        <iron-icon icon="cancel" on-click="removeWorkflowItem" data-workflow-item$="{{workflowItem.id}}"></iron-icon>
                                    </paper-button>
                                </paper-tabs>

                                <iron-pages selected="{{workflowItem.selected}}">
                                    <!-- TODO Eventually the tooling should support pre-populating our "from" and "to" based on the previous/next workflow item (especially if it's a query) -->
                                    <div class="tab-content"> <!-- Properties Page -->
                                        <div class="container flex layout vertical">
                                            <div class="flex">
                                                <paper-input label="Transformer ID:" value="{{workflowItem.item._id}}"></paper-input>
                                            </div>
                                            <div class="flex">    
                                                <paper-input label="Title:" value="{{workflowItem.item.properties.title}}"></paper-input>
                                            </div>
                                            <div class="flex">
                                                <paper-input label="Description:" value="{{workflowItem.item.properties.desc}}"></paper-input>
                                            </div>
                                            <div class="flex">
                                                <iron-label>
                                                    Type:
                                                    <paper-radio-group selected="{{workflowItem.item.properties.type}}">
                                                        <paper-radio-button name="mapper">Mapper</paper-radio-button>
                                                        <paper-radio-button name="function">Function</paper-radio-button>
                                                    </paper-radio-group>
                                                </iron-label>
                                            </div>
                                        </div>
                                    </div>
                                    <template is="dom-if" if="{{_isTransformerMapper(workflowItem.item.properties.type)}}">
                                        <div class="tab-content"> <!-- Transformer Page -->
                                            <!-- TODO Create a proper view and tooling for modifying transformers -->
                                            <div class="layout horizontal">
                                                <div class="flex">
                                                    <paper-listbox selected="{{workflowItem.item.selectedFrom}}">
                                                        <template is="dom-repeat" items="[[workflowItem.item.transformer.from]]" as="from">
                                                            <paper-item>[[from]]</paper-item>
                                                        </template>
                                                    </paper-listbox>
                                                </div>
                                                <div class="horizontal layout center">
                                                    <iron-icon icon="chevron-right"></iron-icon>
                                                </div>
                                                <div class="flex">
                                                    <paper-listbox selected="{{workflowItem.item.selectedTo}}">
                                                        <template is="dom-repeat" items="[[workflowItem.item.transformer.to]]" as="to">
                                                            <paper-item>[[to]]</paper-item>
                                                        </template>
                                                    </paper-listbox>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                    <div class="tab-content"> <!-- Raw Page -->
                                        <!-- TODO If our transformer type is 'function' we need to format our Javascript with proper indents/spacing/etc. -->
                                        <bridgeit-code-editor value="{{_formatTransformer(workflowItem.item.properties.type, workflowItem.item.transform)}}"></bridgeit-code-editor>
                                    </div>
                                </iron-pages>
                            </template>
                        </template>
                    </div>
                </div>
            </div>
            <div class="flex-1 section execute">
                <template is="dom-repeat" items="{{_workflow.query}}" as="workflowItem">
                    <div class="execute-item">
                        <paper-button raised on-click="executeWorkflowItem" data-workflow-item$="{{workflowItem.id}}">
                            <iron-icon on-click="executeWorkflowItem" data-workflow-item$="{{workflowItem.id}}" icon="arrow-forward"></iron-icon>
                        </paper-button>
                    </div>
                </template>
            </div>
            <div id="results" class="flex-2 section results">
                <h2>
                    <button on-click="toggleColumn" data-id="results" data-class="flex-2">&lt;-&gt;</button>
                    Results
                </h2>
                <div class="container flex layout vertical no-padding">
                    <div class="flex">
                        <template is="dom-repeat" items="{{_workflow.query}}" as="workflowItem">
                            <div class="header-panel">
                                <paper-header-panel>
                                    <paper-toolbar><div>Result ([[workflowItem.item._id]])</div></paper-toolbar>
                                    <bridgeit-code-editor readonly value="{{workflowItem.result}}"></bridgeit-code-editor>
                                </paper-header-panel>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </template>
</dom-module>

<script src="./bridgeit-query-chain-editor.js"></script>