<!--
	@license
	Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
	This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
	The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
	The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
	Code distributed by Google as part of the polymer project is also
	subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!doctype html>
<html xmlns="http://www.w3.org/1999/html">
	<head>
		<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
		<title>BridgeIt Web Components Demo</title>

		<!-- Load the bridgeit.js and brideit.io.js scripts and ensure that your page has ES6 Promise support -->
		<script src="//cdn.lukej.me/es6-promise/1.0.0/promise.min.js"></script>
		<script>
			if( !("Promise" in window)){
				window.Promise = ES6Promise.Promise;
			}
		</script>
		<script src="//bridgeit.github.io/bridgeit.js/src/bridgeit.js"></script>
		<script src="../../bridgeit.io.js/lib/bridgeit.io.js"></script>

		<!-- Load the webcomponents polyfill -->
		<script src="../../webcomponentsjs/webcomponents-lite.min.js"></script>

		<!-- Load required jQuery dependency -->
        <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>

		<!-- Load bridgeit query editor component -->
		<link rel="import" href="bridgeit-query-editor.html">
        <!-- Load supporting components (optional) -->
        <link rel="import" href="bridgeit-query-list.html">
        <link rel="import" href="bridgeit-query-results.html">

		<!-- Demo specific CSS -->
		<link rel="stylesheet" href="../common/demo.css"/>
		<style type="text/css">
			.buttons {text-align:center;}
			.buttons button{font-size:13px;padding:5px 10px;color:rgb(239, 239, 239);background-color:rgb(62, 69, 140);margin:10px;}
		</style>

		<!-- Define custom styling for the components (optional) -->
		<style is="custom-style">
			#queryList {
				--query-list-button: { /* [Custom button styling] */
					cursor:pointer;
					padding: 5px 10px;
					color: rgb(239, 239, 239);
					background-color: rgb(62, 69, 140);
					margin: 10px;
				};
				/*
				Other available styling options:
				--query-list-table: { key:value; }; [Custom table styling]
				--query-list-tbody: { key:value; }; [Custom tbody styling]
				--query-list-tr { key:value; }; [Custom tr styling]
				--query-list-td: { key:value; }; [Custom td styling]
				*/
            }
			#queryResults {
				--query-results-table: {
					 width: 100%;
					 margin-bottom: 50px;
			 	};
				--query-results-td: {
					 padding: 8px;
					 line-height: 1.42857143;
					 vertical-align: top;
			 	};
				--query-results-th: {
					 border-bottom-width: 2px;
					 background-color: #EFEFEF;
			 	};
				/*
				Other available styling options:
				--query-results-thead: { key:value; }; [Custom thead styling]
				--query-results-tbody: { key:value; }; [Custom tbody styling]
				--query-results-tr { key:value; }; [Custom tr styling]
				*/
			}
        </style>
	</head>
	<body unresolved>

		<h1>BridgeIt Query Editor Component Demo</h1>
  		<h3>Login with your BridgeIt Account Information</h3>
  		<hr/>
		<div id="listenerWrapper">
			<div id="wrapper" class="container">
				<form>
					<div>
						<label>Account:
							<input id="account" type="text"/>
						</label>
					</div>
					<div>
						<label>Realm:
							<input id="realm" type="text"/>
						</label>
					</div>
					<div>
						<label>Username:
							<input id="username" type="text"/>
						</label>
					</div>
					<div>
						<label>Password:
							<input id="password" type="password"/>
						</label>
					</div>
					<a onclick="login()">Login</a>

					<div class="settings">
						<div>
							<label>Service:
								<select id="service" onchange="serviceChanged()">
									<option selected>documents</option>
									<option>location</option>
									<option>metrics</option>
								</select>
							</label>
						</div>

						<div>
							<label>Collection:
                                <span id="collectionInput">
								    <input id="collection" type="text" onchange="document.getElementById('queryEditor').setAttribute('collection', this.value)"/>
                                </span>
							</label>
						</div>

						<div>
							<label>
								<a onclick="document.getElementById('queryEditor').reloadEditor()">Refresh</a>
							</label>
						</div>
					</div>
				</form>

				  <div>
					  <label>Query URL:
						  <a id="queryURL" target="_blank"></a>
					  </label>
				  </div>

				<!-- 3. Declare the element by its tag. -->
				  <bridgeit-query-editor id="queryEditor"
										 queryurltarget="queryURL">
				  </bridgeit-query-editor>

					<div>
						<div id="msgs"></div>
					</div>

				  <div class="buttons">
					  <button id="resetEditor" onclick="document.getElementById('queryEditor').resetEditor();">New/Reset</button>
					  <button id="runQuery" onclick="document.getElementById('queryEditor').runQuery();">Run Query</button>
					  <button id="saveQuery" onclick="document.getElementById('queryEditor').saveQueryWithPrompt();">Save Query</button>
					  <button id="cloneQuery" onclick="document.getElementById('queryEditor').cloneQueryWithPrompt();">Clone Query</button>
					  <button id="deleteQuery" onclick="document.getElementById('queryEditor').deleteQuery();">Delete Query</button>
				  </div>
				  <br/>
				  <div>
					  <label>Saved Queries:
						  <bridgeit-query-list id="queryList" for="queryEditor"></bridgeit-query-list>
					  </label>
				  </div>
				  <br/>
			</div>
			<div>
				<label>Query Results:
					<bridgeit-query-results id="queryResults" for="queryEditor"></bridgeit-query-results>
				</label>
			</div>
		</div>

		<script type="text/javascript">
            //Listen for the queryMsgUpdated event for all components
            document.getElementById('listenerWrapper').addEventListener('queryMsgUpdated', function(e) {
                var id = e.detail.id ? e.detail.id + ' : ' : '';
                document.getElementById('msgs').innerHTML = id + e.detail.message;
                //clear message 10 seconds after it's received
                clearTimeout(window.msgTimeout);
                window.msgTimeout = setTimeout(function() {
                    document.getElementById('msgs').innerHTML = '';
                },10000);
            });
            //set the service on the component on change
            function serviceChanged() {
                var service = document.getElementById('service').options[document.getElementById('service').selectedIndex].value;
                document.getElementById('queryEditor').setAttribute('service', service);
                var collectionInput = document.getElementById('collectionInput');
                switch (service) {
                    case 'documents':
                        collectionInput.innerHTML = "<input id='collection' type='text'/>";
                        document.getElementById('queryEditor').setAttribute('collection', 'documents');
                        break;
                    case 'location':
                        collectionInput.innerHTML = "<select id='collection'><option selected>regions</option><option>pois</option><option>locations</option></select>";
                        document.getElementById('queryEditor').setAttribute('collection', 'regions');
                        break;
                    case 'metrics':
                        collectionInput.innerHTML = "<select id='collection'><option selected>events</option></select>";
                        document.getElementById('queryEditor').setAttribute('collection', 'events');
                        break;
                }
            }
            //set the collection on the component on change
            document.getElementById('collectionInput').addEventListener('change',function() {
                var collection = document.getElementById('collection');
                document.getElementById('queryEditor').setAttribute('collection',collection.options ? collection.options[collection.selectedIndex].value : collection.value);
            });

			function login(event){
				var account = document.getElementById('account').value;
				var realm = document.getElementById('realm').value;
				var username = document.getElementById('username').value;
				var password = document.getElementById('password').value;

				bridgeit.io.auth.connect({
					account: account,
					realm: realm,
					username: username,
					password: password
				}).then(function(){
					setCredentialsOnComponent();
					initializeComponent();
				})['catch'](function(){
					//try to login as admin
					bridgeit.io.auth.connect({
                        account: account,
						realm: 'admin',
						username: username,
						password: password
					}).then(function(){
						setCredentialsOnComponent();
						document.getElementById('queryEditor').setAttribute('realm', realm);
						initializeComponent();
					})
				});
			}

			function setCredentialsOnComponent(){
				var elem = document.getElementById('queryEditor');

				var account = bridgeit.io.auth.getLastKnownAccount();
				if (account) {
					elem.setAttribute('account', account);
					document.getElementById('account').value = account;
				}

                var realm = bridgeit.io.auth.getLastKnownRealm();
				if (realm) {
					elem.setAttribute('realm', realm);
					document.getElementById('realm').value = realm;
				}

				if (bridgeit.io.auth.isLoggedIn()) {
					document.getElementById('username').value = bridgeit.io.auth.getLastKnownUsername();
				}
			}

			function initializeComponent() {
				document.getElementById('queryEditor').reloadEditor();
				document.getElementById('queryEditor').fetchQueryList();
			}

			//initialize known credentials
			setCredentialsOnComponent();
		</script>
	</body>
</html>
