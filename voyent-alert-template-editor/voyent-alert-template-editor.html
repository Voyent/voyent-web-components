<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../common/imports/voyent.html">
<link rel="import" href="../common/voyent-alert/voyent-alert-map-behaviour.html">
<link rel="import" href="../common/voyent-alert/voyent-alert-behaviour.html">
<link rel="import" href="../common/voyent-alert/voyent-alert-properties.html">
<link rel="import" href="../../paper-dialog/paper-dialog.html">
<link rel="import" href="../../paper-toggle-button/paper-toggle-button.html">

<!--
Displays a map-based tool for creating new alert templates.

Example:

    <voyent-alert-template-editor account="myAccount"
                                  realm="myRealm"
                                  height="500">
    </voyent-alert-template-editor>

@demo demo.html
-->
<dom-module id="voyent-alert-template-editor">
    <template>
        <style include="voyent-alert-styles" is="custom-style">
            #propertiesPanel {
                height: calc(var(--map-height) - 45px);
                width: calc(var(--sidePanel-width,200px));
                display:inline-block;
            }
            .icon-div {
                width:16px;
                height:16px;
                overflow:hidden;
                position:relative;
                display:inline-block;
            }
            .icon {
                position:absolute;
                top:-176px;
            }
            .custom-control {
                margin: -5px 5px 0 0;
            }
        </style>
        <div id="container" data-is-fullscreen$="[[_isFullscreenMode]]">
            <div id="map" data-is-fullscreen$="[[_isFullscreenMode]]"></div>
            <div id$="[[_SIDE_PANEL_ID]]" data-is-fullscreen$="[[_isFullscreenMode]]">
                <div id="propertiesPanel">
                    <template is="dom-if" if="[[_isLoggedIn]]">
                        <voyent-alert-properties parent-is-template-editor
                                                 hide-alert-name
                                                 hide-badge-chooser
                                                 hide-zone-name-editing
                                                 badgedir="{{badgedir}}"
                                                 _loaded-alert="{{_loadedAlert}}"
                                                 _map="{{_map}}"
                                                 _area-region="{{_areaRegion}}"
                                                 _fallback-zone="{{_fallbackZone}}"
                                                 _show-dialog-input="{{_showDialogInput}}"
                                                 _show-dialog-badge="{{_showDialogBadge}}"
                                                 _dialog-input="{{_dialogInput}}"
                                                 _dialog-input-msg="{{_dialogInputMsg}}"
                                                 _show-dialog-toggle="{{_showDialogToggle}}"
                                                 _dialog-toggle="{{_dialogToggle}}"
                                                 _dialog-toggle-label="{{_dialogToggleLabel}}"
                                                 _dialog-badge="{{_dialogBadge}}"
                                                 _dialog-title="{{_dialogTitle}}"
                                                 _dialog-message="{{_dialogMessage}}"
                                                 _dialog-confirm-func="{{_dialogConfirmFunc}}"
                                                 _dialog-cancel-func="{{_dialogCancelFunc}}"
                                                 _new-template-category="{{_newTemplateCategory}}"
                                                 _template-categories="{{_templateCategories}}"
                                                 _filtered-template-categories="{{_filteredTemplateCategories}}"
                                                 _selected-categories="{{_selectedCategories}}"
                                                 _template-save-pending="{{_templateSavePending}}"
                                                 _show-category-manager="{{_showCategoryManager}}"
                                                 _category-search-query="{{_categorySearchQuery}}"
                                                 _drawing-cancelled="{{_drawingCancelled}}"
                                                 _is-zone-selected="{{_isZoneSelected}}"
                                                 _geocode-search-results="{{_geocodeSearchResults}}"
                                                 _geocode-search-query="{{_geocodeSearchQuery}}"
                                                 _last-geocode-search-query="{{_lastGeocodeSearchQuery}}"
                                                 _selected-geocode="{{_selectedGeocode}}">
                        </voyent-alert-properties>
                    </template>
                    <template is="dom-if" if="[[!_isLoggedIn]]">
                        <div class="alert-template-title">Invalid Credentials</div>
                        <div class="alert-template-desc">Login to activate this panel.</div>
                    </template>
                </div><div id="crudPanel">
                    <template is="dom-if" if="[[_loadedAlert]]">
                        <template is="dom-if" if="[[_loadedAlert.template.zoneStacks.length]]">
                            <div class="text-center" style="font-size:12px;">
                                Save Location With Template?
                                <paper-toggle-button class="inline" style="width:150px;"
                                                     checked="{{_loadedAlert.template.savePosition}}">
                                </paper-toggle-button>
                            </div>
                        </template>
                </template>
                </div>
            </div>
        </div>
        <div id$="[[_FULLSCREEN_CONTAINER_ID]]" hidden></div>
        <div id$="[[_FULLSCREEN_BUTTON_ID]]" class="custom-control fullscreen no-select" title="Enter Fullscreen Mode" hidden>
            <img src="../common/voyent-alert/img/fullscreen_bttn.png">
        </div>
        <div id$="[[_CIRCLE_BUTTON_ID]]" class="customMapBttnWrap circleBttn no-select" hidden>
            <div class="customMapBttn" title="Add Circular Zone">
                <span>
                    <div class="customMapBttnImg">
                        <img src="../common/voyent-alert/img/drawing.png">
                    </div>
                </span>
            </div>
        </div>
        <div id$="[[_POLYGON_BUTTON_ID]]" class="customMapBttnWrap polygonBttn no-select" hidden>
            <div class="customMapBttn" title="Add Polygonal Zone">
                <span>
                    <div class="customMapBttnImg">
                        <img src="../common/voyent-alert/img/drawing.png">
                    </div>
                </span>
            </div>
        </div>
        <div id$="[[_FALLBACK_ZONE_BUTTON_ID]]" class="customMapBttnWrap fallbackZoneBttn no-select" hidden>
            <div class="customMapBttn" title="Enable Entire Region Zone">
                <span>
                    <div class="customMapBttnImg">
                        <img src="../common/voyent-alert/img/fallback_zone_bttn.png">
                    </div>
                </span>
            </div>
        </div>
        <div id$="[[_GEOCODE_BUTTON_ID]]" class="customMapBttnWrap geocodeBttn no-select" hidden>
            <div class="customMapBttn" title="Geocode Import">
                <span>
                    <div class="customMapBttnImg">
                        <img src="../common/voyent-alert/img/geo_bttn.png">
                    </div>
                </span>
            </div>
        </div>
        <paper-dialog id="uncategorizedTemplate" modal on-iron-overlay-opened="_patchOverlay">
            <h2 class="dialogH2">Confirm Categories</h2>
            <div class="dialogCloseWrap">
                <paper-icon-button icon="close" on-click="_openCategorySelectorBeforeSave" title="Close dialog"
                                   class="dialogCloseButton"></paper-icon-button>
            </div>
            <div class="dialogEnd"></div>
            <p>No categories have been specified for this template, would you like to specify one now?</p>
            <div class="dialog-bttns text-center">
                <paper-button raised title="Cancel" on-click="_openCategorySelectorBeforeSave">Yes, Choose Category</paper-button>
                <paper-button raised title="Confirm" on-click="_saveAlertTemplateWithoutCategory">No, Save Anyway</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog id="geocodeImport" modal on-iron-overlay-opened="_patchOverlay">
            <h2 class="dialogH2">Import Zone</h2>
            <div class="dialogCloseWrap">
                <paper-icon-button icon="close" on-click="_closeGeocodeImportDialog" title="Close dialog"
                                   class="dialogCloseButton"></paper-icon-button>
            </div>
            <div class="dialogEnd"></div>
            <p class="select-template-msg">
                Begin typing to search for an area, then select a match from the list below:
            </p>
            <div class="search-query-input-wrapper">
                <paper-input label="Search for an area by geocode or name..." autofocus tabindex="1"
                             on-keyup="_geocodeSearchQueryKeyUp" value="{{_geocodeSearchQuery}}"></paper-input>
            </div>
            <!-- 100% height minus the height of the content above and below the table -->
            <div class="table-wrap-dynamic" style="height:calc(100% - 244px);">
                <div class="table table-header-wrap geocode-header">
                    <div class="table-col code-col table-header no-select">Code</div>
                    <div class="table-col name-col table-header no-select">Name</div>
                </div>
                <div id="geocodeSearchResults" class="table-scroll-dynamic" data-is-edge$="[[_isMsEdge()]]">
                    <template is="dom-if" if="[[!_geocodeSearchResults.length]]">
                        <div class="no-query-results-msg">
                            Your search <span class="bold">[[_geocodeSearchQuery]]</span> does not match any areas.
                        </div>
                    </template>
                    <iron-selector id="geocodeSelector" class="alternating-row-parent"
                                   selected="{{_selectedGeocode}}" attr-for-selected="name">
                        <template is="dom-repeat" items="[[_geocodeSearchResults]]" as="geocode" strip-whitespace>
                            <div name="[[geocode]]" class="table pointer geocode-item">
                                <div class="table-col code-col no-select">
                                    [[geocode.code]]
                                </div>
                                <div class="table-col name-col no-select">
                                    [[geocode.name]]
                                </div>
                            </div>
                        </template>
                    </iron-selector>
                </div>
            </div>
            <div class="text-center">
                <paper-button raised title="Cancel import" on-click="_closeGeocodeImportDialog" tabindex="2">Cancel</paper-button>
                <paper-button raised title="Confirm import" on-click="_importGeocodeToMap" tabindex="3">Confirm</paper-button>
            </div>
        </paper-dialog>
    </template>
</dom-module>

<script src="voyent-alert-template-editor.js"></script>
