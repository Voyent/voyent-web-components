<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../common/imports/voyent.html">
<link rel="import" href="../common/voyent-alert/voyent-alert-map-behaviour.html">
<link rel="import" href="../common/voyent-alert/voyent-alert-behaviour.html">
<link rel="import" href="../common/voyent-alert/voyent-alert-properties.html">
<link rel="import" href="../../paper-dialog/paper-dialog.html">
<link rel="import" href="../../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../iron-selector/iron-selector.html">
<link rel="import" href="../common/voyent-custom-validator.html">
<link rel="import" href="../voyent-premium-content/voyent-premium-content.html">

<!--
Displays a map-based tool for creating new alert templates.

Example:

    <voyent-alert-editor account="myAccount"
                                  realm="myRealm"
                                  height="500">
    </voyent-alert-editor>

@demo demo.html
-->
<dom-module id="voyent-alert-editor">
    <template>
        <style include="voyent-alert-styles" is="custom-style">
            #propertiesPanel {
                height: var(--map-height);
                width: calc(var(--sidePanel-width,200px));
                display:inline-block;
            }
            .custom-control {
                margin: -5px 5px 0 0;
            }
            .iron-selected div {
                background-color: var(--app-primary-color,#2E348E);
                color: #FFF;
            }
            .table-wrap {
                margin-top: 0;
            }
            .table-col {
                text-align: center;
                padding: 5px;
            }
            .badge-col {
                width: 10%;
            }
            .name-col {
                width: 50%;
            }
            .categories-col {
                width: 40%;
            }
            .badge-img {
                max-width: 40px;
                max-height: 40px;
                vertical-align: middle;
                padding: 2px 0 2px 0;
            }
            .dialog-buttons-wrapper {
                margin-top: 30px;
            }
            .search-query-input-wrapper {
                margin-top: 0;
            }
            .no-query-results-msg {
                text-align: center;
                margin-top: 15px;
            }
            .select-template-msg {
                margin-bottom: 0;
                padding-bottom: 0;
            }
            .dialogInline {
                display: inline-block;
            }
            #newAlertDialog {
                /* Subtract the height of the VRAS app header so the 90% calculation is accurate */
                height: calc(90% - 64px);
                min-height: 475px;
                margin: 0;
            }
        </style>

        <custom-validator id="fileUploadValidator" validator-name="fileUploadValidator"></custom-validator>

        <div id="container" data-is-fullscreen$="[[_isFullscreenMode]]">
            <div id="map" data-is-fullscreen$="[[_isFullscreenMode]]"></div>
            <div id$="[[_SIDE_PANEL_ID]]" data-is-fullscreen$="[[_isFullscreenMode]]">
                <div id="propertiesPanel">
                    <template is="dom-if" if="[[_isLoggedIn]]">
                        <template is="dom-if" if="[[_showTemplateListPane]]">
                            <template is="dom-if" if="[[!_parentTemplates.length]]">
                                <div class="alert-template-title">New Alert</div>
                                <div class="alert-template-desc">
                                    There are no alert templates to create a new alert from.
                                    Create an alert template before using this editor.
                                </div>
                            </template>
                            <template is="dom-if" if="[[_parentTemplates.length]]">
                                <template is="dom-if" if="[[_displayClickMapMsg]]">
                                    <div class="alert-template-title">New Alert</div>
                                    <div class="alert-template-desc">
                                        Click a location on the map to place the alert...
                                    </div>
                                </template>
                            </template>
                        </template>
                        <template is="dom-if" if="[[_showPropertiesPane]]">
                            <voyent-alert-properties parent-is-alert-editor
                                                     hide-alert-name
                                                     hide-badge-chooser
                                                     show-movement-accordion
                                                     badgedir="{{badgedir}}"
                                                     _loaded-alert="{{_loadedAlert}}"
                                                     _map="{{_map}}"
                                                     _area-region="{{_areaRegion}}"
                                                     _fallback-zone="{{_fallbackZone}}"
                                                     _show-dialog-input="{{_showDialogInput}}"
                                                     _show-dialog-badge="{{_showDialogBadge}}"
                                                     _dialog-input="{{_dialogInput}}"
                                                     _dialog-input-msg="{{_dialogInputMsg}}"
                                                     _show-dialog-toggle="{{_showDialogToggle}}"
                                                     _dialog-toggle="{{_dialogToggle}}"
                                                     _dialog-toggle-label="{{_dialogToggleLabel}}"
                                                     _dialog-badge="{{_dialogBadge}}"
                                                     _dialog-title="{{_dialogTitle}}"
                                                     _dialog-message="{{_dialogMessage}}"
                                                     _dialog-confirm-func="{{_dialogConfirmFunc}}"
                                                     _dialog-cancel-func="{{_dialogCancelFunc}}"
                                                     _alert-direction="{{_alertDirection}}"
                                                     _alert-speed="{{_alertSpeed}}"
                                                     _alert-speed-unit="{{_alertSpeedUnit}}"
                                                     _show-movement="{{_showMovement}}"
                                                     _drawing-cancelled="{{_drawingCancelled}}"
                                                     _is-zone-selected="{{_isZoneSelected}}"
                                                     _last-width="{{_lastWidth}}"
                                                     _last-height="{{_lastHeight}}"
                                                     _zone-to-reshape="{{_zoneToReshape}}"
                                                     _zone-reshape-escape-listener="{{_zoneReshapeEscapeListener}}"
                                                     _cursor-styling-rule="{{_cursorStylingRule}}"
                                                     _active-vertex-details="{{_activeVertexDetails}}"
                                                     _have-vertex-error={{_haveVertexError}}
                                                     _actively-moving-vertex="{{_activelyMovingVertex}}">
                            </voyent-alert-properties>
                        </template>
                    </template>
                    <template is="dom-if" if="[[!_isLoggedIn]]">
                        <div class="alert-template-title">Invalid Credentials</div>
                        <div class="alert-template-desc">Login to activate this panel.</div>
                    </template>
                </div>
            </div></div>
        </div>
        <div id$="[[_ZOOM_BUTTONS_ID]]" class="zoomBttns no-select" hidden>
            <div id="zoomInBttn" class="zoomBttnWrap zoomInBttnWrap" title="Zoom in">
                <div class="zoomBttn zoomInBttn">
                    <img src="../common/voyent-alert/img/tmapctrl_hdpi.png" class="zoomImg zoomInImg">
                </div>
            </div>
            <div class="zoomSeparator"></div>
            <div id="zoomOutBttn" class="zoomBttnWrap zoomOutBttnWrap" title="Zoom out">
                <div class="zoomBttn zoomOutBttn">
                    <img src="../common/voyent-alert/img/tmapctrl_hdpi.png" class="zoomImg zoomOutImg">
                </div>
            </div>
        </div>
        <div id$="[[_MAP_TYPE_BUTTONS_ID]]" class="mapTypeBttns no-select" hidden>
            <div class="mapTypeBttnWrap mapBttnWrap">
                <div id="mapBttn" class="mapTypeBttn mapBttn selected" title="Show street map">
                    Map
                </div>
                <div id="mapTerrainBttn" class="dropdownBttnWrap mapTerrainBttnWrap"
                     title="Show street map with terrain">
                    <div class="dropdownBttn">
                        <span class="checkboxWrap">
                            <div class="checkbox">
                                <img id="mapTerrainCheckbox" class="checkboxImage"
                                     src="../common/voyent-alert/img/imgs8.png">
                            </div>
                        </span>
                        <label class="label">Terrain</label>
                    </div>
                </div>
                <div id="mapPlacesBttn" class="dropdownBttnWrap mapPlacesBttnWrap"
                     title="Show street map with places">
                    <div class="dropdownBttn">
                        <span class="checkboxWrap">
                            <div class="checkbox">
                                <img id="mapPlacesCheckbox" class="checkboxImage"
                                     src="../common/voyent-alert/img/imgs8.png">
                            </div>
                        </span>
                        <label class="label">Places</label>
                    </div>
                </div>
            </div>
            <div class="mapTypeBttnWrap satBttnWrap">
                <div id="satBttn" class="mapTypeBttn satBttn" title="Show satellite imagery">
                    Satellite
                </div>
                <div id="satPlacesBttn" class="dropdownBttnWrap satPlacesBttnWrap"
                     title="Show satellite imagery with places">
                    <div class="dropdownBttn">
                        <span class="checkboxWrap">
                            <div class="checkbox">
                                <img id="satPlacesCheckbox" class="checkboxImage"
                                     src="../common/voyent-alert/img/imgs8.png">
                            </div>
                        </span>
                        <label class="label">Places</label>
                    </div>
                </div>
            </div>
        </div>
        <div id$="[[_FULLSCREEN_CONTAINER_ID]]" hidden></div>
        <div id$="[[_FULLSCREEN_BUTTON_ID]]" class="custom-control fullscreen no-select" hidden>
            <div id="openButton" title="Enter Fullscreen Mode">
                <img src="../common/voyent-alert/img/fullscreen_bttn.png">
            </div>
            <div id="closeButton" title="Exit Fullscreen Mode" hidden>
                <paper-button class="glow-green">Exit Fullscreen</paper-button>
            </div>
        </div>
        <div id$="[[_CIRCLE_BUTTON_ID]]" class="customMapBttnWrap circleBttn no-select" hidden>
            <div class="customMapBttn" title="Add Circular Zone">
                <span>
                    <div class="customMapBttnImg">
                        <img src="../common/voyent-alert/img/drawing.png">
                    </div>
                </span>
            </div>
        </div>
        <div id$="[[_POLYGON_BUTTON_ID]]" class="customMapBttnWrap polygonBttn no-select" hidden>
            <div class="customMapBttn" title="Add Polygonal Zone">
                <span>
                    <div class="customMapBttnImg">
                        <img src="../common/voyent-alert/img/drawing.png">
                    </div>
                </span>
            </div>
        </div>
        <div id$="[[_FALLBACK_ZONE_BUTTON_ID]]" class="customMapBttnWrap fallbackZoneBttn no-select" hidden>
            <div class="customMapBttn" title="Enable Entire Region Zone">
                <span>
                    <div class="customMapBttnImg">
                        <img src="../common/voyent-alert/img/fallback_zone_bttn.png">
                    </div>
                </span>
            </div>
        </div>
        <div id$="[[_IMPORT_BUTTON_ID]]" class="customMapBttnWrap importBttn no-select" hidden>
            <div class="customMapBttn" title="Import a KML or KMZ file...">
                <span>
                    <div class="customMapBttnImg">
                        <paper-icon-button class="fileUploadIcon" icon="file-upload"></paper-icon-button>
                    </div>
                </span>
            </div>
        </div>
        <paper-dialog id="fileImportDialog" modal
                      on-iron-overlay-opened="_patchOverlay" on-iron-overlay-closed="_patchOverlayClosed">
            <h2 class="dialogH2">Import File</h2>
            <div class="dialogCloseWrap">
                <paper-icon-button icon="close" on-click="_closeFileImportDialog" title="Close dialog"
                                   class="dialogCloseButton" tabindex="4"></paper-icon-button>
            </div>
            <div class="dialogEnd"></div>
            <voyent-premium-content>
                <div class="premiumContent">
                    <paper-input id="fileUpload" type="file" label="Import a KML or KMZ file..." tabindex="1"
                                 class="fileUploadInput" validator="fileUploadValidator"></paper-input>
                    <div class="buttonWrapper text-center">
                        <paper-button raised title="Cancel import" on-click="_closeFileImportDialog" tabindex="2">Cancel</paper-button>
                        <paper-button raised title="Confirm import" on-click="_importFile" tabindex="3">Confirm</paper-button>
                    </div>
                </div>
            </voyent-premium-content>
        </paper-dialog>
        <paper-dialog id="newAlertDialog" on-keyup="_submitNewAlertDialog" modal
                      on-iron-overlay-opened="_patchOverlay" on-iron-overlay-closed="_patchOverlayClosed">
            <h2 class="dialogH2">New Alert</h2>
            <div class="dialogCloseWrap">
                <paper-icon-button icon="close" on-click="_cancelNewAlert" title="Close dialog"
                                   tabindex="4" class="dialogCloseButton"></paper-icon-button>
            </div>
            <div class="dialogEnd"></div>
            <p class="select-template-msg">
                Choose a template from the list below:
            </p>
            <div class="search-query-input-wrapper">
                <paper-input id="categoriesQueryInput" label="Filter templates by name or categories..." autofocus tabindex="1"
                             on-keyup="_templateSearchQueryKeyUp" value="{{_templateSearchQuery}}"
                             class="dialogInline" style="width: calc(100% - 210px);"></paper-input>
                <div class="dialogInline" style="width: 200px; text-align: right;">
                    &nbsp;
                    <paper-checkbox checked="{{hideSample}}">Hide Sample Templates</paper-checkbox>
                </div>
            </div>
            <!-- 100% height minus the height of the content above and below the table -->
            <div class="table-wrap-dynamic" style="height:calc(100% - 250px);">
                <div class="table table-header-wrap">
                    <div class="table-col badge-col table-header no-select"></div>
                    <div class="table-col name-col table-header no-select pointer" on-click="_sortTemplatesByName" title="Click to sort by Alert Name">Name</div>
                    <div class="table-col categories-col table-header no-select pointer" on-click="_sortTemplatesByCategories" title="Click to sort by Categories">Categories</div>
                </div>
                <div class="table-scroll-dynamic" data-is-edge$="[[_isMsEdge()]]">
                    <voyent-loading><br/>Retrieving...<br/></voyent-loading>
                    <template is="dom-if" if="[[!_filteredParentTemplates.length]]">
                        <div class="no-query-results-msg">
                            Your search <span class="bold">[[_templateSearchQuery]]</span> does not match any templates.
                        </div>
                    </template>
                    <iron-selector id="newAlertCategories" class="alternating-row-parent"
                                   selected="{{_selectedAlertTemplate}}" attr-for-selected="name">
                        <template id="alertTemplatesList" is="dom-repeat" items="[[_filteredParentTemplates]]"
                                  as="template" sort="_sortTemplates" strip-whitespace>
                            <div name="[[template]]" class="table pointer">
                                <div class="table-col badge-col no-select">
                                    <img class="badge-img" src="[[getBadgeUrl(template.badge)]]" hidden$="[[!hasBadge(template.badge)]]"/>
                                </div>
                                <div class="table-col name-col no-select text-left">
                                    [[template.name]]
                                </div>
                                <div class="table-col categories-col no-select text-left">
                                    [[template.categoriesString]]
                                </div>
                            </div>
                        </template>
                    </iron-selector>
                </div>
            </div>
            <div class="dialog-buttons-wrapper text-center">
                <paper-button raised title="Cancel changes" on-click="_cancelNewAlert" tabindex="2">Cancel</paper-button>
                <paper-button raised title="Confirm changes" on-click="_createNewAlert" tabindex="3">Confirm</paper-button>
            </div>
        </paper-dialog>
    </template>
</dom-module>

<script src="voyent-alert-editor.js"></script>
