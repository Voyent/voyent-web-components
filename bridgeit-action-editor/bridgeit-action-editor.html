<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../bridgeit-io-import/bridgeit-io-import.html">
<link rel="import" href="../../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../bridgeit-query-editor/bridgeit-query-editor.html">
<link rel="import" href="../bridgeit-code-editor/bridgeit-code-editor.html">

<!--
Displays an action editor that can build actions and their associated event handlers.

Example:

    <bridgeit-action-editor realm="myRealm"
                            account="myAccount">
    </bridgeit-action-editor>

@demo demo.html
-->
<dom-module id="bridgeit-action-editor">
    <template>
        <style type="text/css">
           :host {
               font-size:14px;
               @apply(--action-editor);
           }
           .actionWrapper {
               @apply(--action-editor-wrapper);
           }
           .itemsContainer {
               width:160px;
               @apply(--action-editor-item-container);
           }
           .fixedDiv {
               width:160px;
           }
           .actionContainer {
               border: 1px solid #999;
               padding:10px;
               background-color:#efefef;
               min-width:345px;
               min-height:600px;
               @apply(--action-editor-action-container);
           }
           #actionForm {
               background-color:transparent;
               @apply(--action-editor-form);
           }
           .smallerF, .details {
               font-size: smaller;
           }
           .details {
               display: inline;
           }
           .details.toggled {
               display: none;
           }
           .taskPanel {
               border: 1px solid #999;
               border-bottom:0;
               margin-right:5px;
               padding: 10px;
               background-color:#efefef;
               @apply(--action-editor-task-panel);
           }
           .taskPanel .header {
               background-color: #CCC;
               margin: -10px -10px 10px;
               text-align: center;
               cursor:pointer;
               padding-right:21px;
               line-height: 20px;
               @apply(--action-editor-task-panel-header);
           }
           .taskItemPos, .taskPanel .taskClump {
               height: 25px;
               min-height: 25px;
               line-height:25px;
               min-width: 70px;
               width: 90%;
           }
           .taskPanel .taskClump {
               font-weight: bold;
           }
           .taskPanel .taskItem {
               margin: 5px auto;
               padding:2px;
               cursor:move;
               text-align: center;
               border-radius: 5px;
               background-color:#e5e5e5;
               font-size: 12px;
               @apply(--action-editor-task-panel-item);
           }
           .taskPanel .taskItem:hover {
               @apply(--action-editor-task-panel-item-hover);
           }
           .taskPanel .taskGroup {
               background-color:#dbdbdb;
               @apply(--action-editor-task-panel-group-item);
           }
           .task-group {
               position:relative;
               border-radius: 5px;
               padding:10px;
               margin-bottom: 30px;
               background-color:#dbdbdb;
               @apply(--action-editor-task-group);
           }
           .task {
               position:relative;
               border-radius: 5px;
               padding:10px;
               margin-bottom: 10px;
               background-color:#e5e5e5;
               @apply(--action-editor-task);
           }
           .task-group .buttons {
               position: absolute;
               top: 4px;
               right: 15px;
               float:right;
               padding-bottom:5px;
               @apply(--action-editor-task-group-button-container);
           }
           .task .buttons {
               position: absolute;
               top: 4px;
               right: 4px;
               float:right;
               padding-bottom:5px;
               @apply(--action-editor-task-button-container);
           }
           .task-group .title {
               margin-bottom: 10px;
               font-size: 18px;
               cursor:pointer;
               @apply(--action-editor-task-group-title);
           }
           .task .title {
               margin-bottom: 10px;
               font-size: 18px;
               cursor:pointer;
               @apply(--action-editor-task-title);
           }
           .task .code-editor {
               width:100%;
               min-height:200px;
               @apply(--action-editor-function-input);
           }
           .arrow {
               width: 0;
               height: 0;
               border-left: 6px solid transparent;
               border-right: 6px solid transparent;
               border-top: 6px solid #777;
               float:left;
               -moz-transition: -moz-transform .3s;
               -webkit-transition: -webkit-transform .3s;
               -o-transition: -o-transform .3s;
               transition: transform .3s;
               @apply(--action-editor-arrow);
           }
           .arrow.toggled {
               -moz-transform: rotate(-90deg);
               -o-transform: rotate(-90deg);
               -webkit-transform: rotate(-90deg);
               transform: rotate(-90deg);
               @apply(--action-editor-arrow-toggled);
           }
           .taskPanel .arrow {
               margin-top:7px;
               margin-left:10px;
               @apply(--action-editor-task-panel-arrow);
           }
           .task-group .arrow {
               margin-top:8px;
               margin-right: 5px;
               @apply(--action-editor-task-group-arrow);
           }
           .task .arrow {
               margin-top:8px;
               margin-right: 5px;
               @apply(--action-editor-task-arrow);
           }
           .buttonContainer {
               text-align:center;
               @apply(--action-editor-button-container);
           }
           button {
               cursor: pointer;
               @apply(--action-editor-button);
           }
           label {
               font-weight: 700;
               display:block;
               @apply(--action-editor-label);
           }
           .form-control {
               width:100%;
               margin:5px 0 10px 0;
               @apply(--action-editor-input);
           }
           .form-control-chk {
               margin:5px 0 5px 0;
               cursor:pointer;
               @apply(--action-editor-checkbox);
           }
           input:invalid {
               border: 1px solid #a94442 !important;
               @apply(--action-editor-input-invalid);
           }
           span.required {
               color: #a94442;
               @apply(--action-editor-required-asterisk);
           }
           fieldset {
               border: 1px solid #999;
               @apply(--action-editor-fieldset);
           }

            /* Static styles */
           .actionPanel,
           .task-group {
               padding-bottom: 40px !important;
               padding-top: 20px;
           }
           .actionContainer,
           .taskItem,
           .task,
           .task-group{
               border: 1px solid #999;
           }
           .taskPanel:not(:first-child),
           .taskPanel .header:last-child {
               border-bottom: 1px solid #999;
           }
           .task-group:last-of-type {
               margin-bottom:0;
           }
           .task:first-of-type {
               margin-top:10px;
           }
           .task .content fieldset:last-of-type {
               margin-bottom:10px;
           }
           .taskPanel.toggled {
               height:0;
           }
           .task-group.toggled,
           .task.toggled {
               padding-bottom:0 !important;
           }
           .content.toggled {
               display:none;
           }
           .eventHandlerLbl {
               display:block;
               margin-bottom:5px;
           }
           .pointer {
               cursor:pointer;
               margin-bottom:5px;
           }
           .leftPane {
               overflow-y: scroll;
           }
           .taskPane {
               max-height: 500px;
           }
           .taskBuffer {
               margin-bottom: 15px;
           }
           @-webkit-keyframes yellow-fade {   
               0% {background: #ffff79;}
           }
           @keyframes yellow-fade {
               0% {background: #ffff79;}
           }
           @-webkit-keyframes grow-bubble {
               0% {transform: scale(0.2);}
               100% {transform: scale(1.0);}
           }
           @keyframes grow-bubble {
               0% {transform: scale(0.2);}
               100% {transform: scale(1.0);}
           }
           .highlight {
               -webkit-animation: yellow-fade 2s ease-in 1;
               animation: yellow-fade 2s ease-in 1;
           }
           .growbubble {
               -webkit-animation: grow-bubble 500ms;
               animation: grow-bubble 500ms;
           }
        </style>
        <template is="dom-if" if="{{_taskGroupSchemas}}">
            <content select="bridgeit-action-list"></content>
            <div class="buttonContainer">
                <paper-button raised on-click="_resetEditor">New/Reset</paper-button>
                <template is="dom-if" if="{{!_loadedAction}}">
                    <paper-button raised on-click="_saveAction">Save</paper-button>
                </template>
                <template is="dom-if" if="{{_loadedAction}}">
                    <paper-button raised on-click="_updateAction">Update</paper-button>
                    <paper-button raised on-click="_cloneAction">Clone<!-- (Save as new)--></paper-button>
                    <paper-button raised on-click="_deleteAction">Delete</paper-button>
                </template>
            </div>
            <div class="actionWrapper layout horizontal">
                <div class="itemsContainer">
                    <div id="fixedDiv" class="fixedDiv">
                        <div class="layout vertical wrap">
                            <div class="taskPanel">
                                <div class="header" on-click="_toggleTask">Containers<div class="arrow"></div></div>
                                <div class="content layout vertical leftPane">
                                    <template is="dom-repeat" items="{{_taskGroupSchemas}}" sort="_sortTaskItems">
                                        <div class="taskGroup taskItem taskItemPos" draggable="true" on-dragstart="_startDragGroup" on-dragend="_dragEndCommon" title$="{{item.description}}">
                                            <div class="title">{{item.label}}</div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div class="taskPanel">
                                <div class="header" on-click="_toggleTask">Tasks<div class="arrow"></div></div>
                                <div class="content layout vertical leftPane taskPane">
                                    <template is="dom-repeat" items="{{_taskSchemasUI}}">
                                        <div class="taskClump">{{item.label}}</div>
                                        <template is="dom-repeat" items="{{item.schemas}}">
                                            <div class="taskItem taskItemPos" draggable="true" on-dragstart="_startDragTask" on-dragend="_dragEndCommon" title$="{{item.description}}">
                                                <div class="title">{{item.labelUI}}</div>
                                            </div>
                                        </template>
                                        <div class="taskBuffer"/>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="aeMain" class="actionContainer flex" on-dragover="_dragOverAction" on-drop="_dropInAction">
                    <div class="layout vertical">
                        <form id="actionForm">
                            <div class="flex">
                                <div>
                                    <label title="The action ID">
                                        <span class="required">*</span><span>Action Name</span>
                                        <input class="form-control" type="text" placeholder="Action Name" title="The action name" value="{{_actionId::input}}" required>
                                    </label>
                                    <label title="The action description">
                                        <span>Description</span>
                                        <input class="form-control" type="text" placeholder="Action Description" title="The action description" value="{{_actionDesc::input}}">
                                    </label>
                                    <label title="The event handler query" class="eventHandlerLbl">Event Handler Query</label>
                                    <label title="Whether this event handler is active" class="pointer">
                                        <span>Active</span>
                                        <input class="form-control-chk" type="checkbox" title="Toggles active state for the event handler" checked="{{_handlerIsActive::change}}"/>
                                    </label>
                                    <div id="eventHandlerEditor"></div>
                                </div>
                            </div>
                            <div class="actionPanel flex">
                                <!-- The template code below requires a lot of duplication but this approach gives us the most flexibility for the
                                     the various task group and task sections. One improvement that could be made is to find a way to template out
                                     the duplicate code and then insert this template into each section instead of manually duplicating it.
                                 -->
                                <template is="dom-repeat" items="{{_taskGroups}}" as="group">
                                    <div id$="{{group.id}}" class="task-group" on-dragover="_dragOverGroup" on-drop="_dropInGroup">
                                        <div class="buttons">
                                            <button type="button" on-click="_moveTaskGroupUp">Up</span></button>
                                            <button type="button" on-click="_moveTaskGroupDown">Down</button>
                                            <button type="button" on-click="_deleteTaskGroup">Remove</button>
                                        </div>
                                        <div class="title" on-click="_toggleTask">{{group.schema.title}}<span class="smallerF">{{_formatContainerName(group.name, group.schema.taskcount)}}</span><div class="arrow"></div></div>
                                        <div class="content">
                                            <label title="The task group name">
                                                <span class="required">*</span><span>Task Group Name</span>
                                                <input class="form-control" type="text" placeholder="Task Group Name" title="The task group name" value="{{group.name::input}}" required>
                                            </label>
                                            <template is="dom-repeat" items="{{_toArray(group.schema.properties.required)}}" as="property" sort="_sortProperties">
                                                <label>
                                                    <span class="required">*</span><span>{{property.title}}</span>
                                                    <template is="dom-if" if="{{_isString(property.type)}}">
                                                        <template is="dom-if" if="{{_hasEnum(property.enum)}}">
                                                            <select class="form-control" required value="{{property.value::change}}">
                                                                <option value="" selected>Select one...</option>
                                                                <template is="dom-repeat" items="{{property.enum}}">
                                                                    <option value="{{item}}">{{item}}</option>
                                                                </template>
                                                            </select>
                                                        </template>
                                                        <template is="dom-if" if="{{!_hasEnum(property.enum)}}">
                                                            <input class="form-control" type="text" title$="{{property.description}}" placeholder$="{{property.description}}"
                                                                   required value="{{property.value::input}}">
                                                        </template>
                                                    </template>
                                                </label>
                                            </template>
                                            <template is="dom-repeat" items="{{_toArray(group.schema.properties.optional)}}" as="property" sort="_sortProperties">
                                                <label class$="{{_addBooleanClass(property.type)}}">
                                                    <span>{{property.title}}</span>
                                                    <template is="dom-if" if="{{_isString(property.type)}}">
                                                        <template is="dom-if" if="{{_hasEnum(property.enum)}}">
                                                            <select class="form-control" value="{{property.value::change}}">
                                                                <option value="" selected>Select one...</option>
                                                                <template is="dom-repeat" items="{{property.enum}}">
                                                                    <option value="{{item}}">{{item}}</option>
                                                                </template>
                                                            </select>
                                                        </template>
                                                        <template is="dom-if" if="{{!_hasEnum(property.enum)}}">
                                                            <input class="form-control" type="text" title$="{{property.description}}" placeholder$="{{property.description}}"
                                                                   value="{{property.value::input}}">
                                                        </template>
                                                    </template>
                                                    <template is="dom-if" if="{{_isBoolean(property.type)}}">
                                                        <input class="form-control-chk" type="checkbox" title$="{{property.description}}" checked="{{property.value::change}}"/>
                                                    </template>
                                                </label>
                                            </template>
                                            <template is="dom-repeat" items="{{group.tasks}}" as="task">
                                                <div class="task toggled" data-id$="{{task.id}}">
                                                    <div class="buttons">
                                                        <button type="button" on-click="_moveTaskUp">Up</span></button>
                                                        <button type="button" on-click="_moveTaskDown">Down</button>
                                                        <button type="button" on-click="_deleteTask">Remove</button>
                                                    </div>
                                                    <div class="title" on-click="_toggleTask">{{task.schema.title}}<span class="details">{{_formatTaskName(task.name)}}</span><div class="arrow toggled"></div></div>
                                                    <div class="content toggled">
                                                        <label title="The task name">
                                                            <span class="required">*</span><span>Task Name</span>
                                                            <input class="form-control" type="text" placeholder="Task Name" title="The task name" value="{{task.name::input}}" required>
                                                        </label>
                                                        <label title="The task description">
                                                            <span>Description</span>
                                                            <input class="form-control" type="text" placeholder="Task Description" title="The task description" value="{{task.desc::input}}">
                                                        </label>
                                                        <hr/>
                                                        <template is="dom-if" if="{{task.schema.properties.oneOf}}">
                                                            <label>
                                                                <span><span class="required">*</span>One of these property groups are required</span>
                                                            </label>
                                                            <template is="dom-repeat" items="{{task.schema.properties.oneOf}}" as="oneOfGroup">
                                                                <fieldset>
                                                                    <legend>Group <span>{{_toOneBasedIndex(index)}}</span></legend>
                                                                    <template is="dom-repeat" items="{{_toArray(oneOfGroup)}}" as="property" sort="_sortProperties">
                                                                        <label class$="{{_addBooleanClass(property.type)}}">
                                                                            <span>{{property.title}}</span>
                                                                            <template is="dom-if" if="{{_isString(property.type)}}">
                                                                                <template is="dom-if" if="{{_isCodeEditor(property.title)}}">
                                                                                    <bridgeit-code-editor class="code-editor" value="{{property.value}}"
                                                                                                          disablevalidation="{{_disableValidation(property.title)}}"></bridgeit-code-editor>
                                                                                </template>
                                                                                <template is="dom-if" if="{{!_isCodeEditor(property.title)}}">
                                                                                    <template is="dom-if" if="{{_hasEnum(property.enum)}}">
                                                                                        <select class="form-control" value="{{property.value::change}}">
                                                                                            <option value="" selected>Select one...</option>
                                                                                            <template is="dom-repeat" items="{{property.enum}}">
                                                                                                <option value="{{item}}">{{item}}</option>
                                                                                            </template>
                                                                                        </select>
                                                                                    </template>
                                                                                    <template is="dom-if" if="{{!_hasEnum(property.enum)}}">
                                                                                        <input class="form-control" type="text" title$="{{property.description}}" placeholder$="{{property.description}}"
                                                                                               value="{{property.value::input}}">
                                                                                    </template>
                                                                                </template>
                                                                            </template>
                                                                            <template is="dom-if" if="{{_isBoolean(property.type)}}">
                                                                                <input class="form-control-chk" type="checkbox" title$="{{property.description}}" checked="{{property.value::change}}"/>
                                                                            </template>
                                                                        </label>
                                                                    </template>
                                                                </fieldset>
                                                            </template>
                                                        </template>
                                                        <template is="dom-repeat" items="{{_toArray(task.schema.properties.required)}}" as="property" sort="_sortProperties">
                                                            <label class$="{{_addBooleanClass(property.type)}}">
                                                                <span class="required">*</span><span>{{property.title}}</span>
                                                                <template is="dom-if" if="{{_isString(property.type)}}">
                                                                    <template is="dom-if" if="{{_isCodeEditor(property.title)}}">
                                                                        <bridgeit-code-editor class="code-editor" value="{{property.value}}"
                                                                                              disablevalidation="{{_disableValidation(property.title)}}"></bridgeit-code-editor>
                                                                    </template>
                                                                    <template is="dom-if" if="{{!_isCodeEditor(property.title)}}">
                                                                        <template is="dom-if" if="{{_hasEnum(property.enum)}}">
                                                                            <select class="form-control" required value="{{property.value::change}}">
                                                                                <option value="" selected>Select one...</option>
                                                                                <template is="dom-repeat" items="{{property.enum}}">
                                                                                    <option value="{{item}}">{{item}}</option>
                                                                                </template>
                                                                            </select>
                                                                        </template>
                                                                        <template is="dom-if" if="{{!_hasEnum(property.enum)}}">
                                                                            <input class="form-control" type="text" title$="{{property.description}}" placeholder$="{{property.description}}"
                                                                                   required value="{{property.value::input}}">
                                                                        </template>
                                                                    </template>
                                                                </template>
                                                                <template is="dom-if" if="{{_isBoolean(property.type)}}">
                                                                    <input class="form-control-chk" type="checkbox" title$="{{property.description}}" checked="{{property.value::change}}"/>
                                                                </template>
                                                            </label>
                                                        </template>
                                                        <template is="dom-repeat" items="{{_toArray(task.schema.properties.optional)}}" as="property" sort="_sortProperties">
                                                            <label class$="{{_addBooleanClass(property.type)}}">
                                                                <span>{{property.title}}</span>
                                                                <template is="dom-if" if="{{_isString(property.type)}}">
                                                                    <template is="dom-if" if="{{_isCodeEditor(property.title)}}">
                                                                        <bridgeit-code-editor class="code-editor" value="{{property.value}}"
                                                                                              disablevalidation="{{_disableValidation(property.title)}}"></bridgeit-code-editor>
                                                                    </template>
                                                                    <template is="dom-if" if="{{!_isCodeEditor(property.title)}}">
                                                                        <template is="dom-if" if="{{_hasEnum(property.enum)}}">
                                                                            <select class="form-control" value="{{property.value::change}}">
                                                                                <option value="" selected>Select one...</option>
                                                                                <template is="dom-repeat" items="{{property.enum}}">
                                                                                    <option value="{{item}}">{{item}}</option>
                                                                                </template>
                                                                            </select>
                                                                        </template>
                                                                        <template is="dom-if" if="{{!_hasEnum(property.enum)}}">
                                                                            <input class="form-control" type="text" title$="{{property.description}}" placeholder$="{{property.description}}"
                                                                                   value="{{property.value::input}}">
                                                                        </template>
                                                                    </template>
                                                                </template>
                                                                <template is="dom-if" if="{{_isBoolean(property.type)}}">
                                                                    <input class="form-control-chk" type="checkbox" title$="{{property.description}}" checked="{{property.value::change}}"/>
                                                                </template>
                                                            </label>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </template>
    </template>
</dom-module>

<script src="bridgeit-action-editor.js"></script>